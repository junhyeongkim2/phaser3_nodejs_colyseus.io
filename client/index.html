<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë§ˆì´í¬ ë…¹ìŒ</title>
  </head>
  <body>
    <button>ì‹œì‘/ì¢…ë£Œ</button> <br /><br />
    <audio controls>ë…¹ìŒëœ ì†Œë¦¬ë¥¼ ì¬ìƒí•  audio ì—˜ë¦¬ë¨¼íŠ¸</audio>

    <form
      action="http://localhost:3005/audio"
      method="post"
      enctype="multipart/form-data"
    >
      <div class="form-group">
        <label>ì œëª©</label>
        <input type="text" class="form-control" name="title" />
      </div>
      <div class="form-group">
        <label>ë‚´ìš©</label>
        <input type="text" class="form-control" name="singer" />
      </div>

      <div class="form-group">
        <label>íŒŒì¼ ì²¨ë¶€</label>
        <input type="file" class="form-control" name="track" />
      </div>

      <button type="submit" class="btn btn-outline-secondary">Submit</button>
    </form>

    <input
      id="message
    "
    >
  
    <input type="text">ë©”ì„¸ì§€</input>
    <button type="submit" class="btn btn-outline-secondary">send</button>

  
  </form>
  </body>

  <script>
    // ì—˜ë¦¬ë¨¼íŠ¸ ì·¨ë“
    const $audioEl = document.querySelector("audio");
    const $btn = document.querySelector("button");
    // ë…¹ìŒì¤‘ ìƒíƒœ ë³€ìˆ˜
    let isRecording = false;
    // MediaRecorder ë³€ìˆ˜ ìƒì„±
    let mediaRecorder = null;
    // ë…¹ìŒ ë°ì´í„° ì €ì¥ ë°°ì—´
    const audioArray = [];
    $btn.onclick = async function (event) {
      if (!isRecording) {
        console.log("button clicked");
        // ë§ˆì´í¬ mediaStream ìƒì„±: Promiseë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ async/await ì‚¬ìš©
        const mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        }); // MediaRecorder ìƒì„±
        mediaRecorder = new MediaRecorder(mediaStream); // ì´ë²¤íŠ¸í•¸ë“¤ëŸ¬: ë…¹ìŒ ë°ì´í„° ì·¨ë“ ì²˜ë¦¬
        mediaRecorder.ondataavailable = (event) => {
          audioArray.push(event.data); // ì˜¤ë””ì˜¤ ë°ì´í„°ê°€ ì·¨ë“ë  ë•Œë§ˆë‹¤ ë°°ì—´ì— ë‹´ì•„ë‘”ë‹¤.
          console.log(event.data);
        }; // ì´ë²¤íŠ¸í•¸ë“¤ëŸ¬: ë…¹ìŒ ì¢…ë£Œ ì²˜ë¦¬ & ì¬ìƒí•˜ê¸°
        mediaRecorder.onstop = (event) => {
          // ë…¹ìŒì´ ì¢…ë£Œë˜ë©´, ë°°ì—´ì— ë‹´ê¸´ ì˜¤ë””ì˜¤ ë°ì´í„°(Blob)ë“¤ì„ í•©ì¹œë‹¤: ì½”ë±ë„ ì„¤ì •í•´ì¤€ë‹¤.
          const blob = new Blob(audioArray, { type: "audio/ogg codecs=opus" });
          audioArray.splice(0); // ê¸°ì¡´ ì˜¤ë””ì˜¤ ë°ì´í„°ë“¤ì€ ëª¨ë‘ ë¹„ì›Œ ì´ˆê¸°í™”í•œë‹¤. // Blob ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì£¼ì†Œë¥¼ ìƒì„±í•œë‹¤.
          const blobURL = window.URL.createObjectURL(blob); // audioì—˜ë¦¬ë¨¼íŠ¸ë¡œ ì¬ìƒí•œë‹¤.

          $audioEl.src = blobURL;
          console.log(
            "this is audio url !!! = " + blobURL.substr(5, blobURL.length)
          );

          var formdata = new FormData();
          formdata.append("track", blob, blobURL);
          formdata.append("title", "1");
          formdata.append("singer", "testsinger");

          var requestOptions = {
            method: "POST",
            body: formdata,
            redirect: "follow",
          };

          fetch("http://localhost:3005/audio", requestOptions)
            .then((response) => response.text())
            .then((result) => console.log(result))
            .catch((error) => console.log("error", error));

          $audioEl.play();
        }; // ë…¹ìŒ ì‹œì‘
        mediaRecorder.start();
        isRecording = true;
      } else {
        // ë…¹ìŒ ì¢…ë£Œ
        mediaRecorder.stop();
        isRecording = false;
      }
    };


    const fsocket = new WebSocket(`ws://localhost`);

const messageList = document.querySelector("ul");
const messageForm = document.querySelector("#message");
const nickForm = document.querySelector("#nick");

function makeMessage(type, payload) {
  const msg = { type, payload };
  return JSON.stringify(msg);
}

fsocket.addEventListener("open", () => {
  console.log("Connected to Browser ğŸ”§");
});

fsocket.addEventListener("message", (message) => {
  console.log("New Message: ", message.data, " from the server");
  const li = document.createElement("li");
  li.innerText = message.data;
  messageList.append(li);
});
fsocket.addEventListener("close", () => {
  console.log("Disconnected from Server X");
});

function handleSubmit(event) {
  event.preventDefault();
  const input = messageForm.querySelector("input");
  fsocket.send(makeMessage("new_message", input.value));
  input.value = "";
}

function handleNickSubmit(event) {
  event.preventDefault();
  const input = nickForm.querySelector("input");
  fsocket.send(makeMessage("nickname", input.value));
  input.value = "";
}

messageForm.addEventListener("submit", handleSubmit);

nickForm.addEventListener("submit", handleNickSubmit);


  </script>
</html>
